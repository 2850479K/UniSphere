{% extends 'base.html' %}
{% load static %}

{% block title %}Search Users - UniSphere{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Search Users</h2>

    <!-- Search Form -->
    <form method="get" class="row g-3 mb-4">
        <!-- Student Search Fields -->
        <div class="col-md-3"><input type="text" name="username" class="form-control" placeholder="Enter username"></div>
        <div class="col-md-3"><input type="text" name="name" class="form-control" placeholder="Enter name"></div>
        <div class="col-md-3"><input type="text" name="school" class="form-control" placeholder="Enter school"></div>
        <div class="col-md-3"><input type="text" name="course" class="form-control" placeholder="Enter course"></div>
        <div class="col-md-3"><input type="text" name="interests" class="form-control" placeholder="Enter interests"></div>
        <div class="col-md-3"><input type="text" name="skills" class="form-control" placeholder="Enter skills"></div>

        <!-- Society Search Fields -->
        <div class="col-md-3"><input type="text" name="society_name" class="form-control" placeholder="Enter society name"></div>
        <div class="col-md-3"><input type="text" name="category" class="form-control" placeholder="Enter category"></div>

        <div class="col-md-3"><button type="submit" class="btn btn-primary">Search</button></div>
    </form>

    {% if show_results %}
    <h4>Search Results:</h4>

    <!-- Students Section -->
    {% if students %}
    <h5>Students</h5>
<table class="table table-hover table-bordered mt-3">
    <thead class="table-light">
        <tr>
            <th>Profile Picture</th>
            <th>Username</th>
            <th>Full Name</th>
            <th>School</th>
            <th>Course</th>
            <th>Skills</th>
            <th style="width: 240px;">Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for student in students %}
        <tr>
            <td>
                <img src="{{ student.get_profile_picture_url }}" alt="Profile Picture" width="60" class="rounded-circle">
            </td>
            <td>{{ student.user.username }}</td>
            <td>{{ student.full_name }}</td>
            <td>{{ student.school|default:"N/A" }}</td>
            <td>{{ student.course|default:"N/A" }}</td>
            <td>{{ student.skills|default:"N/A" }}</td>
            <td class="d-flex flex-wrap gap-1">
                {% if request.user.is_authenticated and request.user.role == "student" and student.user != request.user %}
                    <button class="btn btn-outline-success btn-sm btn-send-request"
                            data-student-id="{{ student.user.id }}">
                        Send Friend Request
                    </button>
                {% endif %}
                <a href="{% url 'profile' student.user.username %}" class="btn btn-outline-info btn-sm">View Profile</a>
                <a href="{% url 'contact_profile' student.id %}" class="btn btn-outline-primary btn-sm">Contact</a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
    {% else %}
        <p>No students found.</p>
    {% endif %}

    <!-- Societies Section -->
    {% if societies %}
    <h5>Societies</h5>
    <table class="table table-hover table-bordered mt-3">
        <thead class="table-light">
            <tr>
                <th>Society Name</th>
                <th>Category</th>
                <th>Contact Email</th>
                <th style="width: 240px;">Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for society in societies %}
            <tr>
                <td>{{ society.society_name }}</td>
                <td>{{ society.category|default:"N/A" }}</td>
                <td>{{ society.contact_email|default:"N/A" }}</td>
                <td class="d-flex flex-wrap gap-1">
                    <a href="{% url 'profile' society.user.username %}" class="btn btn-outline-info btn-sm">View Profile</a>
                    <a href="{% url 'contact_profile' society.id %}" class="btn btn-outline-primary btn-sm">Contact</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No societies found.</p>
    {% endif %}
    {% endif %}
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100"></div>

<script>
function showToast(message, type = 'info') {
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0 mb-2"
             role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    const container = document.querySelector('.toast-container');
    container.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".btn-send-request").forEach(button => {
        button.addEventListener("click", function() {
            const studentId = this.getAttribute("data-student-id");
            const csrftoken = getCookie('csrftoken');

            fetch(`/friend-request/send/${studentId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ student_id: studentId })
            })
            .then(response => {
                if(!response.ok){
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                console.log(data.message);
                showToast(data.message, 'success');
                this.disabled = true;
                this.innerText = "Request Sent";
                this.classList.remove("btn-outline-success");
                this.classList.add("btn-secondary");
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred', 'danger');
            });
        });
    });
});
</script>
{% endblock %}
